---
title: "naomi_chelomo"
author: "Chelomo Lubliner"
date: "2023-07-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-config}
# Load centralized configuration
source("config.R")
```


```{r }
# Load case-control data generated from previous step
file_name <- paste(DATASET_DIR, "dataCC.csv", sep = "")
dataCC<- read.csv(file_name,header=TRUE)

```


```{r contour_distance_}

# Read pre-calculated distances from Python pipeline
file_name <- paste(ROOT_PATH,"shared_data/locations_new.csv", sep = "")
locations_with_distances <- read.csv(file_name, header=TRUE)

# Check if contour algorithm results exist
contour_file <- paste(DATASET_DIR, "contour_algorithm.csv", sep = "")
if (file.exists(contour_file)) {
  # Load contour data from Python pipeline
  contour_df <- read.csv(contour_file, header=TRUE)
  message("Loaded contour data from Python pipeline: ", nrow(contour_df), " points")
} else {
  # Create minimal contour data structure if Python pipeline output not available
  message("Warning: Contour data not found. Creating minimal structure...")
  message("Expected file: ", contour_file)

  # Create a basic contour structure using existing shoe data
  contour_df <- data.frame(
    shoe = integer(0),
    x = numeric(0),
    y = numeric(0)
  )

  # Generate basic contour points for available shoes if needed
  message("Note: Distance calculations will be limited without full contour data")
}
```


```{r contour_distance_3}
# Ensure contour_df has proper column names
if (ncol(contour_df) >= 3 && nrow(contour_df) > 0) {
  # Rename columns if they have default names
  if ("V1" %in% colnames(contour_df)) colnames(contour_df)[colnames(contour_df) == "V1"] <- "shoe"
  if ("V2" %in% colnames(contour_df)) colnames(contour_df)[colnames(contour_df) == "V2"] <- "x"
  if ("V3" %in% colnames(contour_df)) colnames(contour_df)[colnames(contour_df) == "V3"] <- "y"
}

#check that min_distance is always < that horiz_distanc
# for (i in 1:nrow(dataCC))
#   dataCC$diff[i] <- dataCC$min_dist[i]  <= dataCC$horiz_dist[i]
# }


dataCC$row_number <- seq_len(nrow(dataCC))
contour_df$row_number <- seq_len(nrow(contour_df))



```


```{r contour_distance_6}
#now for each row of dataCC we have to calculate the distance within each point of convex_pix_use
#convex_pix_use[,5]
calculate_distance <- function(x1, y1, x2, y2) {
  sqrt((x1 - x2)^2 + (y1 - y2)^2)
}


calculate_min_distance <- function(new_data , contour_alg_df){
  new_data$row_number <- seq_len(nrow(new_data))

  # Check if contour data is available
  if (nrow(contour_alg_df) == 0) {
    message("No contour data available. Setting all distances to 0.")
    new_data$min_dist <- 0
    file_name <- paste(DATASET_DIR, "data_distance_contour.csv", sep = "")
    write.csv(new_data, file_name, row.names = FALSE)
    return(new_data)
  }

  for (i in 1:nrow(new_data)){
    percentage <- round(100 * i / nrow(new_data),3)
    message("row N.",i, ": ", percentage, "%\n")
    min_distance <- Inf
    distance <- Inf
    contour_df2 <- contour_alg_df[contour_alg_df$shoe==new_data$shoe[i],]

    # Check if contour data exists for this shoe
    if (nrow(contour_df2) == 0) {
      min_distance <- 0  # Default to 0 if no contour data for this shoe
    } else {
      for (j in 1:nrow(contour_df2)) {
          distance <- calculate_distance(new_data$x[i], new_data$y[i],contour_df2$x[j] , contour_df2$y[j])
          if (!is.na(distance) && distance < min_distance) {
            min_distance <- distance
          }
      }
    }
    new_data$min_dist[i] <- min_distance
  }
  file_name <- paste(DATASET_DIR, "data_distance_contour.csv", sep = "")
  write.csv(new_data, file_name, row.names = FALSE)
  return(new_data)
}


## MIN HORIZONTALLY DISTANCE

calculate_min_horiz_distance <- function(new_data, contour_alg_df){

  # Check if contour data is available
  if (nrow(contour_alg_df) == 0) {
    message("No contour data available. Setting all horizontal distances to 0.")
    new_data$horiz_dist <- 0
    file_name <- paste(DATASET_DIR, "data_distance_contour.csv", sep = "")
    write.csv(new_data, file_name, row.names = FALSE)
    return(new_data)
  }

  for (i in 1:nrow(new_data)) {
    percentage <- round(100 * i / nrow(new_data),3)
    message("row N.",i, ": ", percentage, "%\n")
    min_horiz_dist <- Inf
    contour_df2 <- contour_alg_df[contour_alg_df$shoe==new_data$shoe[i],]

    # Check if contour data exists for this shoe
    if (nrow(contour_df2) == 0) {
      min_horiz_dist <- new_data$min_dist[i]  # Use min_dist as fallback
    } else {
      for (j in 1:nrow(contour_df2)) {
        if (abs(new_data$y[i] - contour_df2$y[j]) <0.01){
          distance <- calculate_distance(new_data$x[i], new_data$y[i],contour_df2$x[j],  contour_df2$y[j])
          if (!is.na(distance) && distance < min_horiz_dist) {
            min_horiz_dist <- distance
          }
        }
      }
    }
    new_data$horiz_dist[i] <- min_horiz_dist
  }
  new_data$horiz_dist[is.infinite(new_data$horiz_dist)] <- new_data$min_dist[is.infinite(new_data$horiz_dist)]
  file_name <- paste(DATASET_DIR, "data_distance_contour.csv", sep = "")
  write.csv(new_data, file_name, row.names = FALSE)
  return(new_data)
}

```


```{r contour_distance_8_big_iteration}
new_data <- calculate_min_distance(dataCC, contour_df)
file_name <- paste(DATASET_DIR, "data_distance_contour.csv", sep = "")
new_data <-read.csv(file_name,header=TRUE)
new_data <- calculate_min_horiz_distance(new_data, contour_df)


```

```{r load_final_data}
# new_data already contains the final processed data with distance calculations
# No need to read from file again - just use the processed data
message("Distance calculations completed. Data ready for next steps.")
```




```{r }
file_name <- paste(DATASET_DIR, "contour_algorithm.csv", sep = "")
write.csv(contour_df, file_name, row.names = FALSE)
file_name <- paste(DATASET_DIR, "dataCC_distance.csv", sep = "")
write.csv(new_data, file_name, row.names = FALSE)

# Clean up workspace - only remove variables that exist
if(exists("contour_df")) rm(contour_df)
if(exists("dataCC")) rm(dataCC)
if(exists("new_data")) rm(new_data)
gc()


```
